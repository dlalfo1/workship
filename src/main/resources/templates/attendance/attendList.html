<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
                <!--/* 괄호 안에 이름 바꾸면 페이지 타이틀 정해집니다! */-->
<head th:replace="~{/layout/header::headFrag('workship 출퇴근기록조회')}"></head>
<body>
  <div class="container-scroller">

    <!--/* 상단바 */-->
    <nav th:replace="~{/layout/common::topbarFrag}"></nav>
  
    <!--/* 본문영역 */-->
    <div class="container-fluid page-body-wrapper">
    
      <!--/* 테마설정버튼 영역 */-->
      <div th:replace="~{/layout/common::themeSettingFrag}"></div>   
      <!--/* 사이드바 영역 */-->
      <nav th:replace="~{/layout/sidebar::sidebarFrag}"></nav>
      
      <!--/* 실제 내용 영역 */-->
      <div class="main-panel">
        <div class="content-wrapper">
        
          <!--/* 출근정보 모아보기 */-->
          <div class="row">
          
            <!--/* (끝!) 오늘의 출근정보 */-->
            <div class="col-md-4 stretch-card grid-margin mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <p class="card-title mb-1" th:text="${#calendars.format(#calendars.createNow(), 'yyyy년 MM월 dd일')}"></p>
                  <div class="mb-3">
                    <span class="card-subtitle">현재시간 </span>
                    <span class="card-subtitle" id="nowTime"></span>
                    <script>
                      function clock(){
	                      var today = new Date();
	                      var hours = ('0' + today.getHours()).slice(-2); 
	                      var minutes = ('0' + today.getMinutes()).slice(-2);
	                      var seconds = ('0' + today.getSeconds()).slice(-2);
	                      var time = hours + ':' + minutes + ':' + seconds;
	                      $('#nowTime').text(time);
                      }
                      clock();
                      setInterval(clock, 1000);
                    </script>
                  </div>
                  <div class="row" style="height: 40px;">
                    <div class="col-5">출근시간</div>
                    <div class="col-7 text-primary"><h3 id="aStartTime" th:text="${#dates.format(attendanceToday?.astarttime, 'HH:mm:ss')}"></h3></div>
                  </div>
                  <div class="row" style="height: 40px;">
                    <div class="col-5">퇴근시간</div>
                    <div class="col-7 text-primary"><h3 id="aEndTime" th:text="${#dates.format(attendanceToday?.aendtime, 'HH:mm:ss')}"></h3></div>
                  </div>
                  <div class="row">
	                  <div class="col-6">
	                    <input type="button" onclick="fnAStart()" class="btn btn-outline-primary btn-md" style="width: 100%;" value="출근">
	                  </div>
	                  <div class="col-6 text-center">
	                    <input type="button" onclick="fnAEnd()" class="btn btn-inverse-primary btn-md" style="width: 100%;" value="퇴근">
	                  </div>
                  </div>
 	                <script th:inline="javascript">
	                  function fnAStart(){
	                    var memberNo = /*[[${session.loginMember.memberNo}]]*/ null;
	                    new Promise(function(resolve, reject){
                        $.ajax({
                           type: 'get',
                           url: '/attendance/aStart.do',
                           data: 'memberNo=' + memberNo,
                           dataType: 'json',
                           success: function(resData){
                        	   resolve();
                             var result = resData.result;
                             if(result == 'fail') {
                               alert('이미 출근 처리되었습니다.');
                             } else {
                               $('#aStartTime').text(result.substr(11, 8));
                             }
                           }
                         });
	                    }).then(function(){
	                    	location.href = '/attendance/attendList.do?memberNo=' + memberNo;
	                    })
	                  };
	                  
	                  function fnAEnd(){
											var memberNo = /*[[${session.loginMember.memberNo}]]*/ null;
											new Promise(function(resolve, reject){
												$.ajax({
													type: 'get',
													url: '/attendance/aEnd.do',
													data: 'memberNo=' + memberNo,
													dataType: 'json',
													success: function(resData){
														resolve();
														var result = resData.result;
														if(result == 'noStart') {
														  alert('출근 처리가 되지 않았습니다.');
														} else if(result == 'alreadyEnd') {
														  alert('이미 퇴근 처리되었습니다.');
														} else {
														  $('#aEndTime').text(result.substr(11, 8));
														}
													}
												}).then(function(){
											    location.href = '/attendance/attendList.do?memberNo=' + memberNo;
											})
										})
									};
	                </script>
                </div>
              </div>
            </div>
            
            <!--/* (끝!) 이번달 출근정보 */-->
            <div class="col-md-4 stretch-card grid-margin mb-3">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">이번달 출근 정보</p>
                  <table class="table table-sm table-borderless text-center">
                    <tr><td colspan="8" height="20px"></td></tr>
                    <tr>
                      <th colspan="2" width="25%">정상</th>
                      <th colspan="2" width="25%">지각</th>
                      <th colspan="2" width="25%">조퇴</th>
                      <th colspan="2" width="25%">결근</th>
                    </tr>
                    <tr>
                      <th:block th:each="info:${attendanceInfo}">
                      <td colspan="2"><h3 class="text-secondary" th:text="${info}"></h3></td>
                      </th:block>
                    </tr>
                    <tr><td colspan="8" height="20px"></td></tr>
                    <tr>
                      <th colspan="3">근무시간</th>
                      <td colspan="5"><h3 class="text-secondary" th:text="${worktime}"></h3></td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
            
            <!--/* (끝!) 검색 조건 설정 */-->
            <div class="col-md-4 grid-margin mb-3">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">검색 조건 설정</p>
                  <form id="attendSearch">
                  <div style="margin-bottom: 0.5rem; padding-left: 1rem;">기간 설정</div>
                  <div class="text-center mb-2"> <!--/* 달력모음 */-->
                    <input type="text" id="startDate" name="startDate" style="width: 40%;">
                    <label for="startDate"><i class="fa-regular fa-calendar" style="margin-left:-35px;"></i></label>
                    <span>&nbsp;&nbsp;~&nbsp;&nbsp;</span>
                    <input type="text" id="endDate" name="endDate" style="width: 40%;">
                    <label for="endDate"><i class="fa-regular fa-calendar" style="margin-left:-35px;"></i></label>
                  </div>
                  <div style="padding-left: 1rem;">근태</div>
                  <div class="row" style="padding-left: 1.3rem;"> <!--/* 체크박스모음 */-->
                    <div class="form-check" style="justify-content: space-between;">
                      <label for="checkAll" class="form-check-label">
                      <input type="checkbox" class="form-check-input" id="checkAll">
                      전체&nbsp;&nbsp;
                      </label>
                    </div>
                    <div class="form-check">
                      <label for="normal" class="form-check-label" style="justify-content: space-between;">
	                    <input type="checkbox" name="attendance" class="form-check-input checkOne" id="normal" value="normal">
	                    정상&nbsp;&nbsp;
	                    </label>
                    </div>
                    <div class="form-check">
                      <label for="late" class="form-check-label" style="justify-content: space-between;">
                      <input type="checkbox" name="attendance" class="form-check-input checkOne" id="late" value="late">
                      지각&nbsp;&nbsp;
                      </label>
                    </div>
                    <div class="form-check">
                      <label for="early" class="form-check-label" style="justify-content: space-between;">
                      <input type="checkbox" name="attendance" class="form-check-input checkOne" id="early" value="early">
                      조퇴&nbsp;&nbsp;
                      </label>
                    </div>
                    <div class="form-check">
                      <label for="absent" class="form-check-label" style="justify-content: space-between;">
                      <input type="checkbox" name="attendance" class="form-check-input checkOne" id="absent" value="absent">
                      결근&nbsp;&nbsp;
                      </label>
                    </div>
                  </div>
                  <div class="text-center">
                    <input type="button" class="btn btn-sm btn-primary btn-rounded" onclick="fnSearch()" value="조회">
                  </div>
                  </form>
                </div>
                <script>
                  var startDate = $('#startDate');
                  var endDate = $('#endDate');
                  startDate.datepicker({
                	  maxDate: 0,
                	  onClose: function(selectedDate){
                		  endDate.datepicker('option', 'minDate', selectedDate);
                	  }
                  });
                  endDate.datepicker({
                    maxDate: 0,
                    onClose: function(selectedDate){
                    	startDate.datepicker('option', 'maxDate', selectedDate);
                    }
                  });

                  function fnCheckAll(){
                	  $('#checkAll').on('click', function(){
                		  $('.checkOne').prop('checked', $(this).prop('checked'));
                	  })
                  };
                  
                  function fnCheckOne(){
                	  let chkOne = $('.checkOne');
                	  chkOne.on('click', function(){
                		  let chkCnt = 0;
                		  for(let i = 0; i < chkOne.length; i++){
                			  chkCnt += $(chkOne[i]).prop('checked');
                		  }
                		  $('#checkAll').prop('checked', chkCnt == chkOne.length);
                	  })
                  };
                  
                  fnCheckAll(); fnCheckOne();
                </script>
              </div>
            </div>

          </div>
          
          <!--/* (끝!) 리스트 뿌려줄 테이블 */-->
          <div class="row">
						<div class="col-md-12 stretch-card grid-margin">
							<div class="card">
							  <div class="card-body">
								  <p class="card-title">출퇴근 기록</p>
									<table class="table table-sm table-striped text-center">
										<thead>
										  <tr>
											  <th width="20%">날짜</th>
											  <th width="20%">출근시간</th>
											  <th width="20%">퇴근시간</th>
											  <th width="20%">근무시간</th>
											  <th width="20%">근태</th>
										  </tr>
										</thead>
										<tbody id="attendanceListTableBody">
										  <th:block th:each="attendance:${attendanceList}">
										    <tr>
										      <td th:text="${#dates.format(attendance?.date, 'YYYY-MM-dd')}"></td>
										      <td th:text="${#dates.format(attendance?.astarttime, 'HH:mm:ss')}"></td>
										      <td th:text="${#dates.format(attendance?.aendtime, 'HH:mm:ss')}"></td>
										      <td th:text="${#dates.format(attendance?.worktime, 'HH:mm:ss')}"></td>
										      <td th:text="${attendance?.attendance}"></td>
										    </tr>
									    </th:block>
										</tbody>
									</table>
									<script>
	                  function fnSearch(){
	                	  
	                	  var checkbox = $('.form-check-input');
	                	  var chkCount = 0;
	                	  for(let i = 0; i < checkbox.length; i++){
	                		  chkCount += $(checkbox[i]).prop('checked');
	                	  }
	                	  if(chkCount == 0){
	                		  alert('근태를 선택해주세요!');
	                		  return;
	                	  } else {
	                      $.ajax({
	                        type: 'get',
	                        url: '/attendance/search.do',
	                        data: $('#attendSearch').serialize(),
	                        dataType: 'json',
	                        success: function(resData){
	                          var result = resData.result;
	                          if(result == 'noResult'){
	                        	  $('#attendanceListTableBody').empty();
	                            $('#attendanceListTableBody').append('<tr><td colspan="5">결과가 없습니다.</td></tr>');
	                          } else {
	                        	  $('#attendanceListTableBody').empty();
	                        	  $.each(result, (i, element) => {

	                        		  function getDate(date){
	                        			  var d = new Date(date);
	                        			  month = d.getMonth() + 1;
	                        			  day = d.getDate();
	                        			  year = d.getFullYear();
	                        			  if(month < 10) month = '0' + month;
	                        			  if(day < 10) day = '0' + day;
	                        			  return[year, month, day].join('-');
	                        		  }
	                        		  
	                        		  function getTime(date){
	                        			  var t = new Date(date);
	                        			  hour = t.getHours();
	                        			  minute = t.getMinutes();
	                        			  second = t.getSeconds();
	                        			  if(hour < 10) hour = '0' + hour;
	                        			  if(minute < 10) minute = '0' + minute;
	                        			  if(second < 10) second = '0' + second;
	                        			  return[hour, minute, second].join(':');
	                        		  }

	                        		  var list = '';
	                        		  list += '<tr>';
	                        		  list += '<td>' + getDate(element.date) + '</td>';
	                        		  list += '<td>' + getTime(element.astarttime) + '</td>';
	                        		  list += '<td>' + getTime(element.aendtime) + '</td>';
	                        		  list += '<td>' + getTime(element.worktime) + '</td>';
	                        		  list += '<td>' + element.attendance + '</td>';
	                        		  list += '</tr>';
	                        		  $('#attendanceListTableBody').append(list);
	                        	  })
	                          }
	                        }
	                      })
	                	  }
	                  }
									</script>
							  </div>
							</div>
						</div>
          </div>
          
        </div>  <!--/* content-wrapper 끝나는 지점 */-->
      </div>  <!--/* main-panel 끝나는 지점 */-->      
    </div>  <!--/* page-body-wrapper(사이드바+본문) 끝나는 지점 */-->
  </div>  <!--/* container-scroller(상단바+사이드바+본문) 끝나는 지점 */-->
  
  <!--/* footer 영역 */-->
  <footer th:replace="~{layout/footer::footerFrag}"></footer> 

</body>
</html>
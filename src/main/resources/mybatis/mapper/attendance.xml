<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 @Mapper를 지정한다. -->
<mapper namespace="com.gdu.workship.mapper.AttendanceMapper">

  <select id="getAttendanceToday" parameterType="int" resultType="AttendanceDTO">
   SELECT MEMBER_NO, DATE, ASTARTTIME, AENDTIME, WORKTIME, ATTENDANCE
     FROM ATTENDANCE_T
    WHERE MEMBER_NO = #{memberNo}
      AND DATE = DATE(NOW())
  </select>
  
  <insert id="addAStartTime" parameterType="Map">
    INSERT INTO ATTENDANCE_T
    VALUES (#{memberNo}, DATE(NOW()), #{time}, NULL, NULL, #{attendance})
  </insert>
  
  <update id="addEndTime" parameterType="Map">
    UPDATE ATTENDANCE_T
       SET AENDTIME = #{time}
         , WORKTIME = TIMEDIFF(TIME(#{time}), ASTARTTIME)
         , ATTENDANCE = #{attendance}
     WHERE MEMBER_NO = #{memberNo}
       AND DATE = DATE(NOW())
  </update>
  
	<select id="getMonthlyAttendList" parameterType="int" resultType="AttendanceDTO">
	  SELECT MEMBER_NO, DATE, ASTARTTIME, AENDTIME, WORKTIME, ATTENDANCE
	    FROM ATTENDANCE_T
	   WHERE MEMBER_NO = #{memberNo}
	     AND MONTH(DATE) = MONTH(NOW())
	    <!-- <![CDATA[AND DAY(DATE) < DAY(NOW())]]> --> 
	   ORDER BY DATE DESC
	</select>
	
	<select id="getMonthlyAttendanceInfo" parameterType="Map" resultType="int">
	 SELECT COUNT(*)
	   FROM ATTENDANCE_T
	  WHERE MEMBER_NO = #{memberNo}
	    AND ATTENDANCE LIKE '%${query}%'
      AND MONTH(DATE) = MONTH(NOW())
	</select>
	
	<select id="getMonthlyWorktime" parameterType="int" resultType="date">
	 SELECT IFNULL(WORKTIME, '00:00:00')
	   FROM ATTENDANCE_T
	  WHERE MEMBER_NO = #{memberNo}
	    AND MONTH(DATE) = MONTH(NOW())
	</select>
	
	<select id="searchCount" parameterType="Map" resultType="int">
    SELECT COUNT(*)
      FROM ATTENDANCE_T
     WHERE DATE BETWEEN #{startDate} AND #{endDate}
      AND MEMBER_NO = #{memberNo}
      AND ATTENDANCE IN (${attendance})
	</select>
	
	<select id="searchAttendance" parameterType="Map" resultType="AttendanceDTO">
   SELECT MEMBER_NO, DATE, ASTARTTIME, AENDTIME, WORKTIME, ATTENDANCE
     FROM ATTENDANCE_T
    WHERE DATE BETWEEN #{startDate} AND #{endDate}
      AND MEMBER_NO = #{memberNo}
      AND ATTENDANCE IN (${attendance})
    ORDER BY DATE DESC
    LIMIT #{begin}, #{recordPerPage}
	</select>

</mapper>
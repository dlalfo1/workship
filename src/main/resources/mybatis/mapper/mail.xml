<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 @Mapper를 지정한다. -->
<mapper namespace="com.gdu.workship.mapper.MailMapper">
	
	<resultMap type="MailDTO" id="MailMap">
		<id column="MAIL_NO" property="mailNo"/>
		<result column="MAIL_TITLE" property="mailTitle"/>
		<result column="MAIL_CONTENT" property="mailContent"/>
		<result column="MAIL_HAS_FILE" property="mailHasFile"/>
		<result column="MAIL_DATE" property="mailDate"/>
		<result column="MAIL_CATEGORY" property="mailCategory"/>
		<association javaType="MemberDTO" property="memberDTO">
			<id column="EMAIL_ID" property="emailId"/>
		</association>
		<association javaType="MailToDTO" property="mailToDTO">
			<id column="MAIL_TO_NO" property="mailToNo"/>
		<result column="MAIL_TO" property="mailTo"/>
		<result column="MAIL_TO_ROLE" property="mailToRole"/>
		<result column="MAIL_TO_CATEGORY" property="mailToCategory"/>
		<result column="MAIL_TO_STATUS" property="mailToStatus"/>
		<result column="MAIL_TO_STAR" property="mailToStar"/>
		</association>
	</resultMap>
	
	<resultMap type="MailFileDTO" id="MailFileMap">
		<id column="MAIL_FILE_NO" property="mailFileNo"/>
		<result column="MAIL_FILE_PATH" property="mailFilePath"/>
		<result column="MAIL_FILE_ORIGIN_NAME" property="mailFileOriginName"/>
		<result column="MAIL_FILE_SYSTEM_NAME" property="mailFileSystemName"/>
		<association javaType="MailDTO" property="MailDTO">
			<id column="MAIL_NO" property="mailNo"/>
		</association>
	</resultMap>

	<!-- 메일 개수 확인  -->
	<select id="getMailCount" parameterType="Map" resultType="int">
		SELECT COUNT(DISTINCT M.MAIL_NO)
		  FROM MAIL_T M LEFT JOIN MAIL_TO_T T
		    ON M.MAIL_NO = T.MAIL_NO
		 <choose>
		 	<when test="mailCategory == 'NOREAD'">
		 		<where>
			    	<if test="column != '' and query != ''">
			      		${column} LIKE CONCAT('%', #{query}, '%')
			    	</if>
			    	<if test="emailId != ''">
		 				AND T.MAIL_TO = #{emailId}
		 			</if>
		 			AND T.MAIL_TO_CATEGORY = 'INBOX' AND T.MAIL_TO_STATUS = 'N'
			  	</where>
		 	</when>
		 	
		 	<when test="mailCategory == 'STARRED'">
		 		<where>
			    	<if test="column != '' and query != ''">
			      		${column} LIKE CONCAT('%', #{query}, '%')
			    	</if>
			    	<if test="emailId != ''">
		 				AND (M.EMAIL_ID = #{emailId} OR T.MAIL_TO = #{emailId})
		 			</if>
		 			AND T.MAIL_TO_CATEGORY = 'INBOX' AND T.MAIL_TO_STAR = 'Y' 
			  	</where>
		 	</when>
		 	
		 	<when test="mailCategory == 'INBOX' or mailCategory == 'SPAM' or mailCategory == 'TRASH'">
		 		<where>
			    	<if test="column != '' and query != ''">
			      		${column} LIKE CONCAT('%', #{query}, '%')
			    	</if>
			    	<if test="emailId != '' and mailCategory != null">
		 				AND T.MAIL_TO = #{emailId} AND T.MAIL_TO_CATEGORY = #{mailCategory}
		 			</if>
			  	</where>
		 	</when>
		 	
		 	<when test="mailCategory == 'SENT' or mailCategory == 'DRAFTS'">
		 		<where>
			    	<if test="column != '' and query != ''">
			      		${column} LIKE CONCAT('%', #{query}, '%')
			    	</if>
			    	<if test="emailId != '' and mailCategory != null">
		 				AND M.EMAIL_ID = #{emailId}	AND M.MAIL_CATEGORY = #{mailCategory}
		 			</if>
			  	</where>
		 	</when>
		 </choose>
	</select>
	
	<select id="getMailList" parameterType="Map" resultMap="MailMap">
				  		 
		 <choose>
		 	<when test="mailCategory == 'NOREAD'">
			 	SELECT A.EMAIL_ID, A.MAIL_NO, A.MAIL_TITLE, A.MAIL_CONTENT, A.MAIL_HAS_FILE, A.MAIL_DATE, A.MAIL_TO_NO, A.MAIL_TO, A.MAIL_TO_ROLE, A.MAIL_TO_CATEGORY, A.MAIL_TO_STATUS, A.MAIL_TO_STAR
			  	  FROM (SELECT E.EMAIL_ID, M.MAIL_NO, M.MAIL_TITLE, M.MAIL_CONTENT, M.MAIL_HAS_FILE, M.MAIL_DATE, T.MAIL_TO_NO, T.MAIL_TO, T.MAIL_TO_ROLE, T.MAIL_TO_CATEGORY, T.MAIL_TO_STATUS, T.MAIL_TO_STAR
			  		  FROM MEMBER_T E 
			  		 RIGHT JOIN MAIL_T M ON E.EMAIL_ID = M.EMAIL_ID
			  		 INNER JOIN MAIL_TO_T T ON M.MAIL_NO = T.MAIL_NO	
				  		<where>
				  			<if test="column != '' and query != ''">
				  				${column} LIKE CONCAT('%', #{query}, '%')
				  			</if>
				  			<if test="emailId != ''">
				 				AND T.MAIL_TO = #{emailId}
				 			</if>
				 			AND T.MAIL_TO_CATEGORY = 'INBOX' AND T.MAIL_TO_STATUS = 'N'
				  		</where>) A
				 ORDER BY A.MAIL_DATE DESC
				 LIMIT #{begin}, #{recordPerPage}
		 	</when>
		 	
		 	<when test="mailCategory == 'STARRED'">
		 		SELECT A.EMAIL_ID, A.MAIL_NO, A.MAIL_TITLE, A.MAIL_CONTENT, A.MAIL_HAS_FILE, A.MAIL_DATE, A.MAIL_TO_NO, A.MAIL_TO, A.MAIL_TO_ROLE, A.MAIL_TO_CATEGORY, A.MAIL_TO_STATUS, A.MAIL_TO_STAR
			  	  FROM (SELECT E.EMAIL_ID, M.MAIL_NO, M.MAIL_TITLE, M.MAIL_CONTENT, M.MAIL_HAS_FILE, M.MAIL_DATE, T.MAIL_TO_NO, T.MAIL_TO, T.MAIL_TO_ROLE, T.MAIL_TO_CATEGORY, T.MAIL_TO_STATUS, T.MAIL_TO_STAR
			  		  FROM MEMBER_T E 
			  		 RIGHT JOIN MAIL_T M ON E.EMAIL_ID = M.EMAIL_ID
			  		 INNER JOIN MAIL_TO_T T ON M.MAIL_NO = T.MAIL_NO	
				  		<where>
				  			<if test="column != '' and query != ''">
				  				${column} LIKE CONCAT('%', #{query}, '%')
				  			</if>
				  			<if test="emailId != ''">
				 				AND T.MAIL_TO = #{emailId}
				 			</if>
				 			AND T.MAIL_TO_CATEGORY = 'INBOX' AND T.MAIL_TO_STAR = 'Y' 
				  		</where>) A
				 ORDER BY A.MAIL_DATE DESC
				 LIMIT #{begin}, #{recordPerPage}
		 	</when>
		 	
		 	<when test="mailCategory == 'INBOX' or mailCategory == 'SPAM' or mailCategory == 'TRASH'">
				SELECT A.EMAIL_ID, A.MAIL_NO, A.MAIL_TITLE, A.MAIL_CONTENT, A.MAIL_HAS_FILE, A.MAIL_DATE, A.MAIL_TO_NO, A.MAIL_TO, A.MAIL_TO_ROLE, A.MAIL_TO_CATEGORY, A.MAIL_TO_STATUS, A.MAIL_TO_STAR
			  	  FROM (SELECT E.EMAIL_ID, M.MAIL_NO, M.MAIL_TITLE, M.MAIL_CONTENT, M.MAIL_HAS_FILE, M.MAIL_DATE, T.MAIL_TO_NO, T.MAIL_TO, T.MAIL_TO_ROLE, T.MAIL_TO_CATEGORY, T.MAIL_TO_STATUS, T.MAIL_TO_STAR
			  		  FROM MEMBER_T E 
			  		 RIGHT JOIN MAIL_T M ON E.EMAIL_ID = M.EMAIL_ID
			  		 INNER JOIN MAIL_TO_T T ON M.MAIL_NO = T.MAIL_NO	
				  		<where>
				  			<if test="column != '' and query != ''">
				  				${column} LIKE CONCAT('%', #{query}, '%')
				  			</if>
				  			<if test="emailId != '' and mailCategory != null">
				  				AND T.MAIL_TO = #{emailId} AND T.MAIL_TO_CATEGORY = #{mailCategory}
				  			</if>
				  		</where>) A
				 ORDER BY A.MAIL_DATE DESC
				 LIMIT #{begin}, #{recordPerPage}
		 	</when>
		 	
		 	<when test="mailCategory == 'SENT' or mailCategory == 'DRAFTS'">
		 		SELECT A.EMAIL_ID, A.MAIL_NO, A.MAIL_TITLE, A.MAIL_CONTENT, A.MAIL_HAS_FILE, A.MAIL_DATE, A.MAIL_CATEGORY,A.MAIL_TO
			  	  FROM (SELECT E.EMAIL_ID, M.MAIL_NO, M.MAIL_TITLE, M.MAIL_CONTENT, M.MAIL_HAS_FILE, M.MAIL_DATE, M.MAIL_CATEGORY, T.MAIL_TO
			  		  FROM MEMBER_T E 
			  		 RIGHT JOIN MAIL_T M ON E.EMAIL_ID = M.EMAIL_ID
			  		 INNER JOIN MAIL_TO_T T ON M.MAIL_NO = T.MAIL_NO	
				  		<where>
				  			<if test="column != '' and query != ''">
				  				${column} LIKE CONCAT('%', #{query}, '%')
				  			</if>
				  			<if test="emailId != '' and mailCategory != null">
				  				AND M.EMAIL_ID = #{emailId} AND M.MAIL_CATEGORY = #{mailCategory}
				  			</if>
				  		</where>) A
				 ORDER BY A.MAIL_DATE DESC
				 LIMIT #{begin}, #{recordPerPage}
		 	</when>
		 </choose>
	</select>

</mapper>